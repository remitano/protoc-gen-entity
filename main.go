package main

import (
	"fmt"
	"strings"

	"google.golang.org/protobuf/compiler/protogen"
	"google.golang.org/protobuf/reflect/protoreflect"
)

func basicGoType(fd protoreflect.FieldDescriptor) string {
	switch fd.Kind() {
	case protoreflect.BoolKind:
		return "bool"
	case protoreflect.Int32Kind, protoreflect.Sint32Kind, protoreflect.Fixed32Kind:
		return "int32"
	case protoreflect.Int64Kind, protoreflect.Sint64Kind, protoreflect.Fixed64Kind:
		return "int64"
	case protoreflect.FloatKind:
		return "float32"
	case protoreflect.DoubleKind:
		return "float64"
	case protoreflect.StringKind:
		return "string"
	case protoreflect.BytesKind:
		return "[]byte"
	default:
		return "interface{}"
	}
}

func goTypeForField(field *protogen.Field) string {
	if field.Desc.IsMap() {
		keyDesc := field.Desc.MapKey()
		valDesc := field.Desc.MapValue()
		keyType := basicGoType(keyDesc)

		if valDesc.Kind() == protoreflect.StringKind && strings.HasSuffix(string(field.Desc.Name()), "_by_provider") {
			return fmt.Sprintf("map[%s]*uint256.Int", keyType)
		}

		valType := basicGoType(valDesc)
		return fmt.Sprintf("map[%s]%s", keyType, valType)
	}

	name := string(field.Desc.Name())
	var baseType string

	if strings.HasSuffix(name, "_scaled") {
		baseType = "*uint256.Int"
	} else if field.Desc.Kind() == protoreflect.MessageKind {
		if field.Message.GoIdent.GoImportPath == "google.golang.org/protobuf/types/known/timestamppb" {
			baseType = "*time.Time"
		} else {
			entityName := field.Message.GoIdent.GoName + "Entity"
			baseType = "*" + entityName
		}
	} else {
		baseType = basicGoType(field.Desc)
	}

	if field.Desc.IsList() {
		return "[]" + baseType
	}
	return baseType
}

func needsUint256Import(file *protogen.File) bool {
	for _, message := range file.Messages {
		for _, field := range message.Fields {
			if strings.HasSuffix(string(field.Desc.Name()), "_scaled") || strings.HasSuffix(string(field.Desc.Name()), "_by_provider") {
				return true
			}
		}
	}
	return false
}

func needsTimeImport(file *protogen.File) bool {
	for _, message := range file.Messages {
		for _, field := range message.Fields {
			if field.Desc.Kind() == protoreflect.MessageKind &&
				field.Message.GoIdent.GoImportPath == "google.golang.org/protobuf/types/known/timestamppb" {
				return true
			}
		}
	}
	return false
}

func hasFieldId(message *protogen.Message) bool {
	for _, field := range message.Fields {
		if string(field.Desc.Name()) == "id" {
			return true
		}
	}
	return false
}

func main() {
	protogen.Options{}.Run(func(plugin *protogen.Plugin) error {
		for _, f := range plugin.Files {
			if !f.Generate {
				continue
			}

			filename := f.GeneratedFilenamePrefix + ".go"
			g := plugin.NewGeneratedFile(filename, f.GoImportPath)

			g.P("// Code generated by protoc-gen-entity-v2. DO NOT EDIT.")
			g.P("package ", f.GoPackageName)
			g.P()

			g.P("import (")
			if needsUint256Import(f) {
				g.P(`    "github.com/holiman/uint256"`)
				g.P(`    "trading.engine/go_services/pkg/common/util"`)
			}
			if needsTimeImport(f) {
				g.P(`    "time"`)
				g.P(`    "google.golang.org/protobuf/types/known/timestamppb"`)
			}
			g.P(`    "trading.engine/go_services/pkg/streams/core"`)
			g.P(")")
			g.P()

			for _, message := range f.Messages {
				structName := message.GoIdent.GoName + "Entity"
				pbType := message.GoIdent.GoName

				g.P("type ", structName, " struct {")
				for _, field := range message.Fields {
					goType := goTypeForField(field)
					jsonTag := fmt.Sprintf("`json:\"%s\"`", field.Desc.JSONName())
					g.P("    ", field.GoName, " ", goType, " ", jsonTag)
				}
				g.P("}")
				g.P()

				for _, field := range message.Fields {
					methodName := fmt.Sprintf("Get%s", field.GoName)
					goType := goTypeForField(field)
					g.P("func (a *", structName, ") ", methodName, "() ", goType, " {")
					g.P("    return a.", field.GoName)
					g.P("}")
					g.P()
				}

				// FromPB
				g.P("func (a *", structName, ") FromPB(pb core.DataMessage) {")
				g.P("    in := pb.(*", pbType, ")")
				for _, field := range message.Fields {
					fieldName := field.GoName

					if field.Desc.IsMap() {
						if strings.HasSuffix(string(field.Desc.Name()), "_by_provider") {
							g.P("    if len(in.", fieldName, ") > 0 {")
							g.P("        a.", fieldName, " = make(map[string]*uint256.Int, len(in.", fieldName, "))")
							g.P("        for k, v := range in.", fieldName, " {")
							g.P("            a.", fieldName, "[k] = util.ForceConvertScaledNumberStrToUint256(v)")
							g.P("        }")
							g.P("    }")
						} else {
							g.P("    if len(in.", fieldName, ") > 0 {")
							g.P("        a.", fieldName, " = make(", goTypeForField(field), ", len(in.", fieldName, "))")
							g.P("        for k, v := range in.", fieldName, " {")
							g.P("            a.", fieldName, "[k] = v")
							g.P("        }")
							g.P("    }")
						}
					} else if strings.HasSuffix(string(field.Desc.Name()), "_scaled") {
						g.P("    if in.", fieldName, " != \"\" {")
						g.P("         a.", fieldName, " = util.ForceConvertScaledNumberStrToUint256(in.", fieldName, ")")
						g.P("    }")
					} else if field.Desc.Kind() == protoreflect.MessageKind && field.Message != nil && field.Message.GoIdent.GoImportPath == "google.golang.org/protobuf/types/known/timestamppb" {
						g.P("    if in.", fieldName, " != nil {")
						g.P("        t := in.", fieldName, ".AsTime()")
						g.P("        a.", fieldName, " = &t")
						g.P("    }")
					} else if field.Desc.Kind() == protoreflect.MessageKind {
						if field.Desc.IsList() {
							g.P("    if len(in.", fieldName, ") > 0 {")
							g.P("        a.", fieldName, " = make(", goTypeForField(field), ", len(in.", fieldName, "))")
							g.P("        for i, v := range in.", fieldName, " {")
							g.P("            e := &", field.Message.GoIdent.GoName, "Entity{}")
							g.P("            e.FromPB(v)")
							g.P("            a.", fieldName, "[i] = e")
							g.P("        }")
							g.P("    }")
						} else {
							g.P("    if in.", fieldName, " != nil {")
							g.P("        e := &", field.Message.GoIdent.GoName, "Entity{}")
							g.P("        e.FromPB(in.", fieldName, ")")
							g.P("        a.", fieldName, " = e")
							g.P("    }")
						}
					} else {
						g.P("    a.", fieldName, " = in.", fieldName)
					}
				}
				g.P("}")
				g.P()

				// ToProtoBuf
				g.P("func (a *", structName, ") ToProtoBuf() core.DataMessage {")
				g.P("    out := &", pbType, "{}")
				for _, field := range message.Fields {
					fieldName := field.GoName

					if field.Desc.IsMap() {
						if strings.HasSuffix(string(field.Desc.Name()), "_by_provider") {
							g.P("    if len(a.", fieldName, ") > 0 {")
							g.P("        out.", fieldName, " = make(map[string]string, len(a.", fieldName, "))")
							g.P("        for k, v := range a.", fieldName, " {")
							g.P("            out.", fieldName, "[k] = v.String()")
							g.P("        }")
							g.P("    }")
						} else {
							g.P("    if len(a.", fieldName, ") > 0 {")
							g.P("        out.", fieldName, " = make(", goTypeForField(field), ", len(a.", fieldName, "))")
							g.P("        for k, v := range a.", fieldName, " {")
							g.P("            out.", fieldName, "[k] = v")
							g.P("        }")
							g.P("    }")
						}
					} else if strings.HasSuffix(string(field.Desc.Name()), "_scaled") {
						g.P("    if a.", fieldName, " != nil {")
						g.P("        out.", fieldName, " = a.", fieldName, ".String()")
						g.P("    }")
					} else if field.Desc.Kind() == protoreflect.MessageKind && field.Message != nil && field.Message.GoIdent.GoImportPath == "google.golang.org/protobuf/types/known/timestamppb" {
						g.P("    if a.", fieldName, " != nil {")
						g.P("        out.", fieldName, " = timestamppb.New(*a.", fieldName, ")")
						g.P("    }")
					} else if field.Desc.Kind() == protoreflect.MessageKind {
						if field.Desc.IsList() {
							g.P("    if len(a.", fieldName, ") > 0 {")
							g.P("        out.", fieldName, " = make([]*", field.Message.GoIdent.GoName, ", len(a.", fieldName, "))")
							g.P("        for i, e := range a.", fieldName, " {")
							g.P("            out.", fieldName, "[i] = e.ToProtoBuf().(*", field.Message.GoIdent.GoName, ")")
							g.P("        }")
							g.P("    }")
						} else {
							g.P("    if a.", fieldName, " != nil {")
							g.P("        out.", fieldName, " = a.", fieldName, ".ToProtoBuf().(*", field.Message.GoIdent.GoName, ")")
							g.P("    }")
						}
					} else {
						g.P("    out.", fieldName, " = a.", fieldName)
					}
				}
				g.P("    return out")
				g.P("}")
				g.P()

				// Extension file (.ext.go)
				extFile := f.GeneratedFilenamePrefix + ".ext.go"
				ext := plugin.NewGeneratedFile(extFile, f.GoImportPath)
				ext.P("package ", f.GoPackageName)
				ext.P()
				ext.P("func (a *", structName, ") IdempotencyType() string {")
				ext.P("    return \"", message.GoIdent.GoName, "\"")
				ext.P("}")
				ext.P()
				ext.P("func (a *", structName, ") IdempotencyValue() int64 {")
				if hasFieldId(message) {
					ext.P("    return a.Id")
				} else {
					ext.P("    return int64(-1)")
				}
				ext.P("}")
			}
		}
		return nil
	})
}
